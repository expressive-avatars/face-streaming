var z=Object.defineProperty,Q=Object.defineProperties;var V=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var O=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var U=(t,e,o)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,w=(t,e)=>{for(var o in e||(e={}))O.call(e,o)&&U(t,o,e[o]);if(L)for(var o of L(e))E.call(e,o)&&U(t,o,e[o]);return t},v=(t,e)=>Q(t,V(e));var R=(t,e)=>{var o={};for(var n in t)O.call(t,n)&&e.indexOf(n)<0&&(o[n]=t[n]);if(t!=null&&L)for(var n of L(t))e.indexOf(n)<0&&E.call(t,n)&&(o[n]=t[n]);return o};import{j as i,r as u,u as A,M as p,E as $,R as F,Q as b,a as J,C as G,X as K,c as Y,V as P,b as x,l as Z,d as m,F as C,e as ee,f as te,g as oe}from"./vendor.bcd2a67b.js";const ne=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}};ne();function S(o){var n=o,{primary:t=!1}=n,e=R(n,["primary"]);return i("button",w({className:`${t?"border-0 text-white bg-hubs-blue hover:bh-hubs-lightblue":"border-2 border-hubs-blue text-hubs-blue hover:text-hubs-lightblue"} font-semibold px-5 py-2 rounded-lg`},e))}function k(){const[t]=u.exports.useState(()=>{try{const e=re("credentials");return JSON.parse(e)}catch{return null}});return t}function re(t){let e=t+"=",n=decodeURIComponent(document.cookie).split(";");for(let r=0;r<n.length;r++){let s=n[r];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(e)==0)return s.substring(e.length,s.length)}return""}function D(t=()=>{}){const{gl:e}=A(),{xr:o}=e,[n,r]=u.exports.useState(()=>o.getSession());return u.exports.useEffect(()=>{const s=()=>{const a=o.getSession();t(a),r(a)};return o.addEventListener("sessionstart",s),o.addEventListener("sessionend",s),()=>{o.removeEventListener("sessionstart",s),o.removeEventListener("sessionend",s)}},[o]),n}function M(t){const e=D(),[o,n]=u.exports.useState();return u.exports.useEffect(()=>{e&&e.requestReferenceSpace(t).then(r=>n(r))},[e]),o}const T=new p,N=new b,f=new $,_=F.createContext();function se({children:t}){const e=u.exports.useRef(new Set),[[o,n]]=u.exports.useState(()=>[new b,new b]);D(c=>{c&&c.updateWorldSensingState({meshDetectionState:{enabled:!0}})});const r=M("local"),s=M("viewer");J((c,l)=>{const h=l.worldInformation;h.meshes&&r&&s&&h.meshes.forEach(d=>{if(d.changed&&d.blendShapes&&d.modelMatrix){const H=ie(d.blendShapes);T.fromArray(d.modelMatrix),o.setFromRotationMatrix(T);const y=l.getPose(s,r).transform.orientation;N.set(y.x,y.y,y.z,y.w),o.premultiply(N),f.setFromQuaternion(o),f.y=-f.y,f.z=-f.z,o.setFromEuler(f),e.current.forEach(W=>{W(H,o)})}})});const a={register:c=>(e.current.add(c),()=>e.current.delete(c))};return i(_.Provider,{children:t,value:a})}const q={browDownLeft:"browDownRight",browDownRight:"browDownLeft",browInnerUp:"browInnerUp",browOuterUpLeft:"browOuterUpRight",browOuterUpRight:"browOuterUpLeft",cheekPuff:"cheekPuff",cheekSquintLeft:"cheekSquintRight",cheekSquintRight:"cheekSquintLeft",eyeBlinkLeft:"eyeBlinkRight",eyeBlinkRight:"eyeBlinkLeft",eyeLookDownLeft:"eyeLookDownRight",eyeLookDownRight:"eyeLookDownLeft",eyeLookInLeft:"eyeLookInRight",eyeLookInRight:"eyeLookInLeft",eyeLookOutLeft:"eyeLookOutRight",eyeLookOutRight:"eyeLookOutLeft",eyeLookUpLeft:"eyeLookUpRight",eyeLookUpRight:"eyeLookUpLeft",eyeSquintLeft:"eyeSquintRight",eyeSquintRight:"eyeSquintLeft",eyeWideLeft:"eyeWideRight",eyeWideRight:"eyeWideLeft",jawForward:"jawForward",jawLeft:"jawRight",jawOpen:"jawOpen",jawRight:"jawLeft",mouthClose:"mouthClose",mouthDimpleLeft:"mouthDimpleRight",mouthDimpleRight:"mouthDimpleLeft",mouthFrownLeft:"mouthFrownRight",mouthFrownRight:"mouthFrownLeft",mouthFunnel:"mouthFunnel",mouthLeft:"mouthRight",mouthLowerDownLeft:"mouthLowerDownRight",mouthLowerDownRight:"mouthLowerDownLeft",mouthPressLeft:"mouthPressRight",mouthPressRight:"mouthPressLeft",mouthPucker:"mouthPucker",mouthRight:"mouthLeft",mouthRollLower:"mouthRollLower",mouthRollUpper:"mouthRollUpper",mouthShrugLower:"mouthShrugLower",mouthShrugUpper:"mouthShrugUpper",mouthSmileLeft:"mouthSmileRight",mouthSmileRight:"mouthSmileLeft",mouthStretchLeft:"mouthStretchRight",mouthStretchRight:"mouthStretchLeft",mouthUpperUpLeft:"mouthUpperUpRight",mouthUpperUpRight:"mouthUpperUpLeft",noseSneerLeft:"noseSneerRight",noseSneerRight:"noseSneerLeft"};function ie(t){return Object.fromEntries(Object.keys(q).map(e=>{var o;return[e,(o=t[q[e]])!=null?o:0]}))}class ae{constructor(e,o={}){this.session=null,this.renderer=e,this.sessionInit=o,this._makeDefaultOverlay()}_makeDefaultOverlay(){if(this.sessionInit.domOverlay===void 0){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e);const o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("width",38),o.setAttribute("height",38),o.style.position="absolute",o.style.right="20px",o.style.top="20px",o.addEventListener("click",()=>{this.session.end()}),e.appendChild(o);const n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M 12,12 L 28,28 M 28,12 12,28"),n.setAttribute("stroke","#fff"),n.setAttribute("stroke-width",2),o.appendChild(n),this.sessionInit.optionalFeatures===void 0&&(this.sessionInit.optionalFeatures=[]),this.sessionInit.optionalFeatures.push("dom-overlay"),this.sessionInit.domOverlay={root:e}}}start(){navigator.xr.requestSession("immersive-ar",this.sessionInit).then(this.onSessionStarted.bind(this)).catch(e=>console.log("Failed to start AR session"))}end(){this.session.end()}get domOverlay(){return this.sessionInit.domOverlay}async onSessionStarted(e){this.session=e,e.addEventListener("end",this.onSessionEnded.bind(this)),this.renderer.xr.setReferenceSpaceType("local"),await this.renderer.xr.setSession(e),this.sessionInit.domOverlay.root.style.display=""}onSessionEnded(){this.session=null}}function ce(r){var s=r,{onCreated:t,children:e,sessionInit:o}=s,n=R(s,["onCreated","children","sessionInit"]);return i(ue,v(w({onCreated:t},n),{children:e}))}function ue(n){var r=n,{foveation:t,children:e}=r,o=R(r,["foveation","children"]);return i(G,v(w({vr:!0},o),{children:i(K,{foveation:t,children:e})}))}function le({children:t}){const{camera:e}=A();return Y(t,e)}function I(t){const{register:e}=u.exports.useContext(_);u.exports.useEffect(()=>e(t),[t])}const g=new P,j=new P;class B{constructor(e){if(!e.isMesh)throw new Error("CPUMorpher requires a THREE.Mesh instance");if(this.mesh=e,!e.geometry.getAttribute("_position")){const o=e.geometry.getAttribute("position").clone();e.geometry.setAttribute("_position",o)}this.morphTargetInfluences=Array.from(e.morphTargetInfluences)}_applyMorphTargetInfluences(e){const o=this.mesh.geometry.getAttribute("position"),n=this.mesh.geometry.getAttribute("_position");for(let r=0;r<o.count;++r){g.fromBufferAttribute(n,r);for(let s=0;s<e.length;++s){const a=this.mesh.geometry.morphAttributes.position[s];j.fromBufferAttribute(a,r),g.addScaledVector(j,e[s])}o.setXYZ(r,g.x,g.y,g.z)}o.needsUpdate=!0}update(){this._applyMorphTargetInfluences(this.morphTargetInfluences)}}new p;function he(){const{scene:t,nodes:e}=x("/faceless-avatar.glb",null,!0),{bones:o,meshes:n,morphers:r}=u.exports.useMemo(()=>{const s={head:e.Head,eyeL:e.LeftEye,eyeR:e.RightEye},a=[];t.traverse(l=>{l.isMesh&&l.morphTargetInfluences.length>0&&a.push(l)});const c=a.map(l=>new B(l));return{bones:s,meshes:a,morphers:c}},[e]);return Object.assign(window,{meshes:n}),u.exports.useEffect(()=>{t.traverse(s=>{s.isMesh&&(s.material.metalness=1,s.material.roughness=.1,s.material.color.set("white"))})},[t]),I((s,a)=>{o.head.setRotationFromQuaternion(a);for(let c of r){for(let l in s){const h=c.mesh.morphTargetDictionary[l];c.morphTargetInfluences[h]=s[l]}c.update()}}),i("primitive",{object:t})}x.preload("/faceless-avatar.glb");function de(t,e){return u.exports.useMemo(()=>Z(t,e),[t])}new b;new p;new p;new p;function me({socket:t}){return I((e,o)=>{t.volatile.emit("face",{blendShapes:e,headOrientation:o.toArray()})}),null}function fe({path:t}){const{scene:e,nodes:o}=x(t),{bones:n,meshes:r,morphers:s}=u.exports.useMemo(()=>{const a={head:o.Head,eyeL:o.LeftEye,eyeR:o.RightEye},c=[];e.traverse(h=>{var d;h.isMesh&&((d=h.morphTargetInfluences)==null?void 0:d.length)>0&&c.push(h)});const l=c.map(h=>new B(h));return{bones:a,meshes:c,morphers:l}},[t]);return I((a,c)=>{n.head.setRotationFromQuaternion(c);for(let l of s){for(let h in a){const d=l.mesh.morphTargetDictionary[h];l.morphTargetInfluences[d]=a[h]}l.update()}try{n.eyeR.rotation.set(-Math.PI/2+a.eyeLookDownRight*.5-a.eyeLookUpRight*.5,0,Math.PI-a.eyeLookOutRight+a.eyeLookOutLeft),n.eyeL.rotation.copy(n.eyeR.rotation)}catch{}}),i("primitive",{object:e})}function pe(){const[t]=u.exports.useState(()=>new ae),e=a=>{t.renderer=a.gl,t.sessionInit.optionalFeatures=["worldSensing"],t.start()},{token:o}=k(),n=de("https://expressive-avatars-server.herokuapp.com/provider",{query:{token:o}}),[r,s]=u.exports.useState();return u.exports.useEffect(()=>{const a=c=>s(c);return n.on("hub_name",a),()=>n.removeListener("hub_name",a)},[n]),m(C,{children:[i(ce,{onCreated:e,children:i(u.exports.Suspense,{fallback:null,children:i(ge,{socket:n})})}),ee.exports.createPortal(i("div",{className:"fixed bottom-0 flex justify-center w-full",children:m("div",{className:"bg-white rounded-t-lg shadow-lg w-[450px] mx-8 p-8 flex flex-col items-center gap-4",children:[m("div",{className:"flex flex-col items-center",children:[m("span",{className:"flex items-center gap-2",children:[i(ye,{color:r?"green":"orange",size:10}),r?"Connected":"Waiting for connection..."]}),i("p",{className:"text-hubs-gray",children:r!=null?r:"Join a compatible room on Hubs desktop"})]}),m("span",{className:"flex gap-4",children:[i(S,{children:"Recenter"}),i(S,{children:"Pause"})]})]})}),t.domOverlay.root)]})}function ge({socket:t}){const[e,o]=u.exports.useState();return u.exports.useEffect(()=>{const n=r=>o(r);return t.on("avatar_url",n),()=>t.removeListener("avatar_url",n)},[t]),m(se,{children:[i(te,{preset:"apartment",background:!0}),i(me,{socket:t}),i(le,{children:i("group",{"position-z":-5,scale:10,children:i("group",{position:[0,-.6,0],"scale-x":-1,children:e?i(fe,{path:e}):i(he,{})})})})]})}function ye({color:t="green",size:e=10}){return i("div",{style:{display:"inline-block",width:e,height:e,backgroundColor:t,borderRadius:9999}})}function Le(){const[t,e]=u.exports.useState(!1);return t?i(pe,{}):i(we,{onStart:()=>{console.log("starting XR session"),e(!0)}})}function we({onStart:t}){const e=k();return m("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[i("img",{alt:"Augmented Environments Lab logo",src:"/ael-logo.jpg",width:200}),e?i(be,{onStart:t}):i(Re,{})]})}function Re(){const t=X();return i("a",{href:t,children:i(S,{children:"Sign In"})})}function be({onStart:t}){const{email:e}=k(),o=X();return m(C,{children:[m("div",{className:"mb-6 text-center",children:[m("p",{children:["Signed in as ",i("span",{className:"font-semibold",children:Se(e)})]}),i("a",{className:"text-hubs-blue hover:text-hubs-lightblue",href:o,children:"Switch account"})]}),i(S,{primary:!0,onClick:t,children:"Start Tracking"})]})}function Se(t){const[e,o]=t.split("@");return`${e.substring(0,3)}...@${o}`}function X(){const t=new URL("https://hubs.aelatgt.net/signin");return t.searchParams.set("sign_in_destination_url","https://ios.aelatgt.net"),t.toString()}oe.render(i(F.StrictMode,{children:i(Le,{})}),document.getElementById("root"));
