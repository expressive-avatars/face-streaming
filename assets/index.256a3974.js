var V=Object.defineProperty,z=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var E=(t,e,s)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,R=(t,e)=>{for(var s in e||(e={}))N.call(e,s)&&E(t,s,e[s]);if(v)for(var s of v(e))P.call(e,s)&&E(t,s,e[s]);return t},A=(t,e)=>z(t,Q(e));var k=(t,e)=>{var s={};for(var o in t)N.call(t,o)&&e.indexOf(o)<0&&(s[o]=t[o]);if(t!=null&&v)for(var o of v(t))e.indexOf(o)<0&&P.call(t,o)&&(s[o]=t[o]);return s};var p=(t,e,s)=>(E(t,typeof e!="symbol"?e+"":e,s),s);import{j as n,a as l,p as $,r as C,l as J,u as G,Q as I,C as K,X as Y,b as L,c as U,d,V as F,e as Z,M as ee,E as te,f as se,g as ne,B as re,h as oe,i as ie,F as O,k as ae,m as ce,R as le,n as ue}from"./vendor.4240c317.js";const de=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const h of i.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&o(h)}).observe(document,{childList:!0,subtree:!0});function s(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=s(r);fetch(r.href,i)}};de();function w(o){var r=o,{primary:t=!1,className:e}=r,s=k(r,["primary","className"]);return n("button",R({className:`${e} ${t?"border-0 text-white bg-hubs-blue hover:bh-hubs-lightblue":"border-2 border-hubs-blue text-hubs-blue hover:text-hubs-lightblue"} font-semibold px-5 py-2 rounded-lg flex items-center justify-center gap-2`},s))}class he{constructor(e,s={}){this.session=null,this.renderer=e,this.sessionInit=s,this._makeDefaultOverlay()}_makeDefaultOverlay(){if(this.sessionInit.domOverlay===void 0){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e),this.sessionInit.optionalFeatures===void 0&&(this.sessionInit.optionalFeatures=[]),this.sessionInit.optionalFeatures.push("dom-overlay"),this.sessionInit.domOverlay={root:e}}}start(){navigator.xr.requestSession("immersive-ar",this.sessionInit).then(this.onSessionStarted.bind(this)).catch(e=>console.log("Failed to start AR session"))}end(){this.session.end()}get domOverlay(){return this.sessionInit.domOverlay}async onSessionStarted(e){this.session=e,e.addEventListener("end",this.onSessionEnded.bind(this)),this.renderer.xr.setReferenceSpaceType("local"),await this.renderer.xr.setSession(e),this.sessionInit.domOverlay.root.style.display=""}onSessionEnded(){this.session=null}}function pe(){return n("div",{className:"bg-white h-screen w-screen grid place-items-center gap-2",children:l("ul",{className:"w-72 list-decimal grid gap-2",children:[n("h1",{className:"font-bold mb-4 text-xl",children:"Almost there..."}),n("li",{children:"Swipe down on the status bar at the top of the screen"}),n("li",{children:"Tap the 3 dots in the URL bar"}),n("img",{src:"/breadcrumbs.jpg"}),n("li",{children:'Tap "Switch Camera"'}),n("img",{src:"/switch-camera.jpg",height:200})]})})}function me(t){let e=t+"=",o=decodeURIComponent(document.cookie).split(";");for(let r=0;r<o.length;r++){let i=o[r];for(;i.charAt(0)==" ";)i=i.substring(1);if(i.indexOf(e)==0)return i.substring(e.length,i.length)}return""}function fe(){try{const t=me("credentials");return JSON.parse(t)}catch{return null}}class ge{constructor(){p(this,"trackingStarted",!1);p(this,"needsCalibration",!0);p(this,"paused",!1);p(this,"previewHidden",!1);p(this,"hubName",null);p(this,"avatarURL",null);p(this,"calibrationOrientation",C(new I));p(this,"subscribers",C(new Set));p(this,"credentials",fe());p(this,"socket",null)}initSocket(){const e=J("https://expressive-avatars-server.herokuapp.com/provider",{query:{token:this.credentials.token}});return e.on("state",s=>{console.log("state",s),Object.assign(this,s)}),e.on("action",s=>{switch(s){case"calibrate":a.calibrate();break}}),this.socket=C(e),this.socket}register(e){return this.subscribers.add(e),()=>this.subscribers.delete(e)}calibrate(){this.needsCalibrate=!0}togglePause(){this.paused=!this.paused}}const a=$(new ge),b=()=>G(a);function be({hubName:t}){const e=()=>a.calibrate(),s=()=>{a.paused=!a.paused,a.socket.emit("state",{paused:a.paused})},o=b();return n("div",{className:"fixed bottom-0 flex justify-center w-full",children:l("div",{className:"bg-white rounded-t-lg shadow-lg w-[450px] mx-8 p-8 flex flex-col items-center gap-4",children:[l("div",{className:"flex flex-col items-center",children:[l("span",{className:"flex items-center gap-2",children:[n(ye,{color:t?"green":"orange",size:10}),t?"Connected":"Waiting for connection..."]}),n("p",{className:"text-hubs-gray",children:t!=null?t:"Join a compatible room on Hubs desktop"})]}),l("span",{className:"flex gap-4",children:[l(w,{onClick:e,children:[n("span",{className:"bx bx-target-lock text-[20px]"})," Recenter"]}),n(w,{primary:o.paused,className:"w-[50px]",onClick:s,children:o.paused?n("span",{className:"bx bx-play scale-[2]"}):n("span",{className:"bx bx-pause scale-[2]"})}),n(w,{primary:o.previewHidden,className:"w-[50px]",onClick:()=>a.previewHidden=!a.previewHidden,children:o.previewHidden?n("span",{className:"bx bx-show scale-[2]"}):n("span",{className:"bx bx-hide scale-[2]"})})]})]})})}function ye({color:t="green",size:e=10}){return n("div",{style:{display:"inline-block",width:e,height:e,backgroundColor:t,borderRadius:9999}})}function we(r){var i=r,{onCreated:t,children:e,sessionInit:s}=i,o=k(i,["onCreated","children","sessionInit"]);return n(xe,A(R({onCreated:t},o),{children:e}))}function xe(o){var r=o,{foveation:t,children:e}=r,s=k(r,["foveation","children"]);return n(K,A(R({vr:!0},s),{children:n(Y,{foveation:t,children:e})}))}function Se({children:t}){const{camera:e}=L();return U(t,e)}function M(t){d.exports.useEffect(()=>a.register(t),[t])}function ve({socket:t}){return M((e,s)=>{t.volatile.emit("face",{blendShapes:e,headOrientation:s.toArray()})}),null}const x=new F,T=new F;class Re{constructor(e){if(!e.isMesh)throw new Error("CPUMorpher requires a THREE.Mesh instance");if(this.mesh=e,!e.geometry.getAttribute("_position")){const s=e.geometry.getAttribute("position").clone();e.geometry.setAttribute("_position",s)}this.morphTargetInfluences=Array.from(e.morphTargetInfluences)}_applyMorphTargetInfluences(e){const s=this.mesh.geometry.getAttribute("position"),o=this.mesh.geometry.getAttribute("_position");for(let r=0;r<s.count;++r){x.fromBufferAttribute(o,r);for(let i=0;i<e.length;++i){const h=this.mesh.geometry.morphAttributes.position[i];T.fromBufferAttribute(h,r),x.addScaledVector(T,e[i])}s.setXYZ(r,x.x,x.y,x.z)}s.needsUpdate=!0}update(){this._applyMorphTargetInfluences(this.morphTargetInfluences)}}function ke({path:t}){const e=t!=null?t:"/faceless-avatar.glb",{scene:s,nodes:o}=Z(e);t||s.traverse(c=>{c.isMesh&&(c.material.roughness=.1,c.material.color.set("white"))});const{bones:r,meshes:i,morphers:h}=d.exports.useMemo(()=>{const c={head:o.Head,eyeL:o.LeftEye,eyeR:o.RightEye},f=[];s.traverse(u=>{var g;u.isMesh&&((g=u.morphTargetInfluences)==null?void 0:g.length)>0&&f.push(u)});const m=f.map(u=>new Re(u));return{bones:c,meshes:f,morphers:m}},[t]);return M((c,f)=>{r.head.setRotationFromQuaternion(f);for(let m of h){for(let u in c){const g=m.mesh.morphTargetDictionary[u];m.morphTargetInfluences[g]=c[u]}m.update()}try{r.eyeR.rotation.set(-Math.PI/2+c.eyeLookDownRight*.5-c.eyeLookUpRight*.5,0,Math.PI-c.eyeLookOutRight+c.eyeLookOutLeft),r.eyeL.rotation.copy(r.eyeR.rotation)}catch{}}),n("primitive",{object:s})}function D(t=()=>{}){const{gl:e}=L(),{xr:s}=e,[o,r]=d.exports.useState(()=>s.getSession());return d.exports.useEffect(()=>{const i=()=>{const h=s.getSession();t(h),r(h)};return s.addEventListener("sessionstart",i),s.addEventListener("sessionend",i),()=>{s.removeEventListener("sessionstart",i),s.removeEventListener("sessionend",i)}},[s]),o}function j(t){const e=D(),[s,o]=d.exports.useState();return d.exports.useEffect(()=>{e&&e.requestReferenceSpace(t).then(r=>o(r))},[e]),s}function Le(t){return Object.fromEntries(Object.keys(_).map(e=>{var r,i;const s=_[e];let o=(r=t[s])!=null?r:0;return o*=(i=Oe[s])!=null?i:1,[e,o]}))}const Oe={mouthSmileLeft:.6,mouthSmileRight:.6},B=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"],Ee=t=>t.includes("Right")?t.replace("Right","Left"):t.replace("Left","Right"),_=Object.fromEntries(B.map(t=>[t,Ee(t)])),Ae=Object.fromEntries(B.map(t=>[t,0])),H=new ee,q=new I,y=new te;function Ce({socket:t}){const[e]=d.exports.useState(()=>new I),s=D(c=>{c&&c.updateWorldSensingState({meshDetectionState:{enabled:!0}})}),o=()=>{e.identity(),a.subscribers.forEach(c=>{c(Ae,e)})},r=b();d.exports.useEffect(()=>{s&&s.updateWorldSensingState({meshDetectionState:{enabled:!r.paused}}),r.paused&&o()},[r.paused]);const i=j("local"),h=j("viewer");return se((c,f)=>{const m=f.worldInformation;m.meshes&&i&&h&&m.meshes.forEach(u=>{if(u.changed&&u.blendShapes&&u.modelMatrix){const g=Le(u.blendShapes);H.fromArray(u.modelMatrix),e.setFromRotationMatrix(H);const S=f.getPose(h,i).transform.orientation;q.set(S.x,S.y,S.z,S.w),e.premultiply(q),y.setFromQuaternion(e),y.y=-y.y,y.z=-y.z,e.setFromEuler(y),a.needsCalibrate&&(a.calibrationOrientation.copy(e).invert(),a.needsCalibrate=!1),e.premultiply(a.calibrationOrientation),a.subscribers.forEach(W=>{W(g,e)}),a.trackingStarted||(a.trackingStarted=!0)}})}),null}function Ie(){const[t,e]=d.exports.useState(window.innerWidth/window.innerHeight);return ne(s=>{const o=window.innerWidth/window.innerHeight;o!==t&&e(o)}),t}function Ne({color:t="white"}){const{camera:e}=L();return U(n(re,{children:n("meshBasicMaterial",{color:t,side:oe})}),e)}function Pe({color:t="black"}){const{set:e}=L();return d.exports.useLayoutEffect(()=>{e(({scene:s})=>void(s.background=new ie(t)))},[t]),null}function Ue(){const[t]=d.exports.useState(()=>new he),e=s=>{t.renderer=s.gl,t.sessionInit.optionalFeatures=["worldSensing"],t.start()};return d.exports.useEffect(()=>{a.initSocket()},[]),l(O,{children:[n(we,{onCreated:e,children:n(Me,{})}),ae.exports.createPortal(n(Fe,{}),t.domOverlay.root)]})}function Fe(){const t=b();return l(O,{children:[t.previewHidden&&l("div",{className:"fixed w-screen h-screen grid text-center place-content-center gap-4",children:[n("p",{className:"text-hubs-gray",children:"(Preview hidden)"}),l("p",{className:"text-xl text-black",children:["Facetracking is ",n("b",{className:"text-black underline",children:t.paused?"PAUSED":"ACTIVE"})]})]}),t.trackingStarted?n(be,{hubName:t.hubName}):n(pe,{})]})}function Me(){const t=b(),e=t.socket,o=Ie()>1,{isPresenting:r}=ce(),i=t.previewHidden||!t.trackingStarted;return l(O,{children:[i&&n(Ne,{color:"white"}),l(d.exports.Suspense,{fallback:null,children:[l("group",{children:[n("ambientLight",{}),n("directionalLight",{position:[1,1,1]}),n("directionalLight",{position:[-1,1,-1]})]}),n(Pe,{color:"lightblue"}),n(Ce,{socket:e}),n(ve,{socket:e}),n(Se,{children:n("group",{"position-z":o?-6:-5,scale:10,children:n("group",{position:[0,-.6,0],"scale-x":-1,children:r&&n(ke,{path:t.avatarURL})})})})]})]})}function Te(){const[t,e]=d.exports.useState(!1);return t?n(Ue,{}):n(De,{onStartAR:()=>{console.log("starting XR session"),e(!0)}})}function De({onStartAR:t}){const e=b(),s=navigator.userAgent.includes("WebXRViewer");let o;return s?e.credentials?o=n(_e,{onStartAR:t}):o=n(Be,{}):o=n(je,{}),l("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[n("img",{alt:"Augmented Environments Lab logo",src:"/ael-logo.jpg",width:200}),o]})}function je(){return l("div",{className:"grid gap-10 place-items-center px-8",children:[n("p",{className:"text-center",children:"Please visit this page in WebXR Viewer on a supported iOS device."}),n("a",{href:"https://apps.apple.com/us/app/webxr-viewer/id1295998056?itsct=apps_box_badge&itscg=30200",style:{display:"inline-block",overflow:"hidden",borderRadius:"13px",width:"250px",height:"83px"},children:n("img",{src:"https://tools.applemediaservices.com/api/badges/download-on-the-app-store/black/en-us?size=250x83&releaseDate=1512604800&h=337a4ee86d323f6cc8ce8ab793b4b045",alt:"Download on the App Store",style:{borderRadius:"13px",width:"250px",height:"83px"}})})]})}function Be(){const t=X();return n("a",{href:t,children:n(w,{children:"Sign In"})})}function _e({onStartAR:t}){const e=b(),s=X();return l(O,{children:[l("div",{className:"mb-6 text-center",children:[l("p",{children:["Signed in as ",n("span",{className:"font-semibold",children:He(e.credentials.email)})]}),n("a",{className:"text-hubs-blue hover:text-hubs-lightblue",href:s,children:"Switch account"})]}),n(w,{primary:!0,onClick:t,children:"Start Tracking"})]})}function He(t){const[e,s]=t.split("@");return`${e.substring(0,3)}...@${s}`}function X(){const t=new URL("https://hubs.aelatgt.net/signin");return t.searchParams.set("sign_in_destination_url","https://ios.aelatgt.net"),t.toString()}le.render(n(ue.StrictMode,{children:n(Te,{})}),document.getElementById("root"));
