var V=Object.defineProperty,z=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var O=(t,e,n)=>e in t?V(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,R=(t,e)=>{for(var n in e||(e={}))N.call(e,n)&&O(t,n,e[n]);if(v)for(var n of v(e))P.call(e,n)&&O(t,n,e[n]);return t},E=(t,e)=>z(t,Q(e));var k=(t,e)=>{var n={};for(var o in t)N.call(t,o)&&e.indexOf(o)<0&&(n[o]=t[o]);if(t!=null&&v)for(var o of v(t))e.indexOf(o)<0&&P.call(t,o)&&(n[o]=t[o]);return n};var p=(t,e,n)=>(O(t,typeof e!="symbol"?e+"":e,n),n);import{j as s,a as l,p as $,r as I,l as J,u as G,Q as C,C as K,X as Y,b as A,c as F,d as h,V as U,e as Z,M as ee,E as te,f as ne,g as se,B as re,h as oe,F as L,i as ie,k as ae,R as ce,m as le}from"./vendor.b97fed0d.js";const ue=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}};ue();function w(o){var r=o,{primary:t=!1,className:e}=r,n=k(r,["primary","className"]);return s("button",R({className:`${e} ${t?"border-0 text-white bg-hubs-blue hover:bh-hubs-lightblue":"border-2 border-hubs-blue text-hubs-blue hover:text-hubs-lightblue"} font-semibold px-5 py-2 rounded-lg flex items-center justify-center gap-2`},n))}class de{constructor(e,n={}){this.session=null,this.renderer=e,this.sessionInit=n,this._makeDefaultOverlay()}_makeDefaultOverlay(){if(this.sessionInit.domOverlay===void 0){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e),this.sessionInit.optionalFeatures===void 0&&(this.sessionInit.optionalFeatures=[]),this.sessionInit.optionalFeatures.push("dom-overlay"),this.sessionInit.domOverlay={root:e}}}start(){navigator.xr.requestSession("immersive-ar",this.sessionInit).then(this.onSessionStarted.bind(this)).catch(e=>console.log("Failed to start AR session"))}end(){this.session.end()}get domOverlay(){return this.sessionInit.domOverlay}async onSessionStarted(e){this.session=e,e.addEventListener("end",this.onSessionEnded.bind(this)),this.renderer.xr.setReferenceSpaceType("local"),await this.renderer.xr.setSession(e),this.sessionInit.domOverlay.root.style.display=""}onSessionEnded(){this.session=null}}function he(){return s("div",{className:"bg-white h-screen w-screen grid place-items-center gap-2",children:l("ul",{className:"w-72 list-decimal grid gap-2",children:[s("h1",{className:"font-bold mb-4 text-xl",children:"Almost there..."}),s("li",{children:"Swipe down on the status bar at the top of the screen"}),s("li",{children:"Tap the 3 dots in the URL bar"}),s("img",{src:"/breadcrumbs.jpg"}),s("li",{children:'Tap "Switch Camera"'}),s("img",{src:"/switch-camera.jpg",height:200})]})})}function pe(t){let e=t+"=",o=decodeURIComponent(document.cookie).split(";");for(let r=0;r<o.length;r++){let i=o[r];for(;i.charAt(0)==" ";)i=i.substring(1);if(i.indexOf(e)==0)return i.substring(e.length,i.length)}return""}function me(){try{const t=pe("credentials");return JSON.parse(t)}catch{return null}}class fe{constructor(){p(this,"trackingStarted",!1);p(this,"needsCalibration",!0);p(this,"paused",!1);p(this,"previewHidden",!1);p(this,"hubName",null);p(this,"avatarURL",null);p(this,"calibrationOrientation",I(new C));p(this,"subscribers",I(new Set));p(this,"credentials",me());p(this,"socket",null)}initSocket(){const e=J("https://expressive-avatars-server.herokuapp.com/provider",{query:{token:this.credentials.token}});return e.on("state",n=>{console.log("state",n),Object.assign(this,n)}),e.on("action",n=>{switch(n){case"calibrate":c.calibrate();break}}),this.socket=I(e),this.socket}register(e){return this.subscribers.add(e),()=>this.subscribers.delete(e)}calibrate(){this.needsCalibrate=!0}togglePause(){this.paused=!this.paused}}const c=$(new fe),b=()=>G(c);function ge({hubName:t}){const e=()=>c.calibrate(),n=()=>{c.paused=!c.paused,c.socket.emit("state",{paused:c.paused})},o=b();return s("div",{className:"fixed bottom-0 flex justify-center w-full",children:l("div",{className:"bg-white rounded-t-lg shadow-lg w-[450px] mx-8 p-8 flex flex-col items-center gap-4",children:[l("div",{className:"flex flex-col items-center",children:[l("span",{className:"flex items-center gap-2",children:[s(be,{color:t?"green":"orange",size:10}),t?"Connected":"Waiting for connection..."]}),s("p",{className:"text-hubs-gray",children:t!=null?t:"Join a compatible room on Hubs desktop"})]}),l("span",{className:"flex gap-4",children:[l(w,{onClick:e,children:[s("span",{className:"bx bx-target-lock text-[20px]"})," Recenter"]}),s(w,{primary:o.paused,className:"w-[50px]",onClick:n,children:o.paused?s("span",{className:"bx bx-play scale-[2]"}):s("span",{className:"bx bx-pause scale-[2]"})}),s(w,{primary:o.previewHidden,className:"w-[50px]",onClick:()=>c.previewHidden=!c.previewHidden,children:o.previewHidden?s("span",{className:"bx bx-show scale-[2]"}):s("span",{className:"bx bx-hide scale-[2]"})})]})]})})}function be({color:t="green",size:e=10}){return s("div",{style:{display:"inline-block",width:e,height:e,backgroundColor:t,borderRadius:9999}})}function ye(r){var i=r,{onCreated:t,children:e,sessionInit:n}=i,o=k(i,["onCreated","children","sessionInit"]);return s(we,E(R({onCreated:t},o),{children:e}))}function we(o){var r=o,{foveation:t,children:e}=r,n=k(r,["foveation","children"]);return s(K,E(R({vr:!0},n),{children:s(Y,{foveation:t,children:e})}))}function Se({children:t}){const{camera:e}=A();return F(t,e)}function M(t){h.exports.useEffect(()=>c.register(t),[t])}function xe({socket:t}){return M((e,n)=>{t.volatile.emit("face",{blendShapes:e,headOrientation:n.toArray()})}),null}const S=new U,T=new U;class ve{constructor(e){if(!e.isMesh)throw new Error("CPUMorpher requires a THREE.Mesh instance");if(this.mesh=e,!e.geometry.getAttribute("_position")){const n=e.geometry.getAttribute("position").clone();e.geometry.setAttribute("_position",n)}this.morphTargetInfluences=Array.from(e.morphTargetInfluences)}_applyMorphTargetInfluences(e){const n=this.mesh.geometry.getAttribute("position"),o=this.mesh.geometry.getAttribute("_position");for(let r=0;r<n.count;++r){S.fromBufferAttribute(o,r);for(let i=0;i<e.length;++i){const d=this.mesh.geometry.morphAttributes.position[i];T.fromBufferAttribute(d,r),S.addScaledVector(T,e[i])}n.setXYZ(r,S.x,S.y,S.z)}n.needsUpdate=!0}update(){this._applyMorphTargetInfluences(this.morphTargetInfluences)}}function Re({path:t}){const e=t!=null?t:"/faceless-avatar.glb",{scene:n,nodes:o}=Z(e);t||n.traverse(a=>{a.isMesh&&(a.material.metalness=1,a.material.roughness=.1,a.material.color.set("white"))});const{bones:r,meshes:i,morphers:d}=h.exports.useMemo(()=>{const a={head:o.Head,eyeL:o.LeftEye,eyeR:o.RightEye},f=[];n.traverse(u=>{var g;u.isMesh&&((g=u.morphTargetInfluences)==null?void 0:g.length)>0&&f.push(u)});const m=f.map(u=>new ve(u));return{bones:a,meshes:f,morphers:m}},[t]);return M((a,f)=>{r.head.setRotationFromQuaternion(f);for(let m of d){for(let u in a){const g=m.mesh.morphTargetDictionary[u];m.morphTargetInfluences[g]=a[u]}m.update()}try{r.eyeR.rotation.set(-Math.PI/2+a.eyeLookDownRight*.5-a.eyeLookUpRight*.5,0,Math.PI-a.eyeLookOutRight+a.eyeLookOutLeft),r.eyeL.rotation.copy(r.eyeR.rotation)}catch{}}),s("primitive",{object:n})}function D(t=()=>{}){const{gl:e}=A(),{xr:n}=e,[o,r]=h.exports.useState(()=>n.getSession());return h.exports.useEffect(()=>{const i=()=>{const d=n.getSession();t(d),r(d)};return n.addEventListener("sessionstart",i),n.addEventListener("sessionend",i),()=>{n.removeEventListener("sessionstart",i),n.removeEventListener("sessionend",i)}},[n]),o}function j(t){const e=D(),[n,o]=h.exports.useState();return h.exports.useEffect(()=>{e&&e.requestReferenceSpace(t).then(r=>o(r))},[e]),n}function ke(t){return Object.fromEntries(Object.keys(B).map(e=>{var r,i;const n=B[e];let o=(r=t[n])!=null?r:0;return o*=(i=Le[n])!=null?i:1,[e,o]}))}const Le={mouthSmileLeft:.6,mouthSmileRight:.6},H=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"],Oe=t=>t.includes("Right")?t.replace("Right","Left"):t.replace("Left","Right"),B=Object.fromEntries(H.map(t=>[t,Oe(t)])),Ee=Object.fromEntries(H.map(t=>[t,0])),_=new ee,q=new C,y=new te;function Ie({socket:t}){const[e]=h.exports.useState(()=>new C),n=D(a=>{a&&a.updateWorldSensingState({meshDetectionState:{enabled:!0}})}),o=()=>{e.identity(),c.subscribers.forEach(a=>{a(Ee,e)})},r=b();h.exports.useEffect(()=>{n&&n.updateWorldSensingState({meshDetectionState:{enabled:!r.paused}}),r.paused&&o()},[r.paused]);const i=j("local"),d=j("viewer");return ne((a,f)=>{const m=f.worldInformation;m.meshes&&i&&d&&m.meshes.forEach(u=>{if(u.changed&&u.blendShapes&&u.modelMatrix){const g=ke(u.blendShapes);_.fromArray(u.modelMatrix),e.setFromRotationMatrix(_);const x=f.getPose(d,i).transform.orientation;q.set(x.x,x.y,x.z,x.w),e.premultiply(q),y.setFromQuaternion(e),y.y=-y.y,y.z=-y.z,e.setFromEuler(y),c.needsCalibrate&&(c.calibrationOrientation.copy(e).invert(),c.needsCalibrate=!1),e.premultiply(c.calibrationOrientation),c.subscribers.forEach(X=>{X(g,e)}),c.trackingStarted||(c.trackingStarted=!0)}})}),null}function Ce(){const[t,e]=h.exports.useState(window.innerWidth/window.innerHeight);return se(n=>{const o=window.innerWidth/window.innerHeight;o!==t&&e(o)}),t}function Ae({color:t="white"}){const{camera:e}=A();return F(s(re,{children:s("meshBasicMaterial",{color:t,side:oe})}),e)}function Ne(){const[t]=h.exports.useState(()=>new de),e=n=>{t.renderer=n.gl,t.sessionInit.optionalFeatures=["worldSensing"],t.start()};return h.exports.useEffect(()=>{c.initSocket()},[]),l(L,{children:[s(ye,{onCreated:e,children:s(Fe,{})}),ie.exports.createPortal(s(Pe,{}),t.domOverlay.root)]})}function Pe(){const t=b();return l(L,{children:[t.previewHidden&&l("div",{className:"fixed w-screen h-screen grid text-center place-content-center gap-4",children:[s("p",{className:"text-hubs-gray",children:"(Preview hidden)"}),l("p",{className:"text-xl text-black",children:["Facetracking is ",s("b",{className:"text-black underline",children:t.paused?"PAUSED":"ACTIVE"})]})]}),t.trackingStarted?s(ge,{hubName:t.hubName}):s(he,{})]})}function Fe(){const t=b(),e=t.socket,o=Ce()>1,r=t.previewHidden||!t.trackingStarted;return l(L,{children:[r&&s(Ae,{color:"white"}),l(h.exports.Suspense,{fallback:null,children:[s(ae,{preset:"apartment",background:!0}),s(Ie,{socket:e}),s(xe,{socket:e}),s(Se,{children:s("group",{"position-z":o?-6:-5,scale:10,children:s("group",{position:[0,-.6,0],"scale-x":-1,children:s(Re,{path:t.avatarURL})})})})]})]})}function Ue(){const[t,e]=h.exports.useState(!1);return t?s(Ne,{}):s(Me,{onStartAR:()=>{console.log("starting XR session"),e(!0)}})}function Me({onStartAR:t}){const e=b();return l("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[s("img",{alt:"Augmented Environments Lab logo",src:"/ael-logo.jpg",width:200}),e.credentials?s(De,{onStartAR:t}):s(Te,{})]})}function Te(){const t=W();return s("a",{href:t,children:s(w,{children:"Sign In"})})}function De({onStartAR:t}){const e=b(),n=W();return l(L,{children:[l("div",{className:"mb-6 text-center",children:[l("p",{children:["Signed in as ",s("span",{className:"font-semibold",children:je(e.credentials.email)})]}),s("a",{className:"text-hubs-blue hover:text-hubs-lightblue",href:n,children:"Switch account"})]}),s(w,{primary:!0,onClick:t,children:"Start Tracking"})]})}function je(t){const[e,n]=t.split("@");return`${e.substring(0,3)}...@${n}`}function W(){const t=new URL("https://hubs.aelatgt.net/signin");return t.searchParams.set("sign_in_destination_url","https://ios.aelatgt.net"),t.toString()}ce.render(s(le.StrictMode,{children:s(Ue,{})}),document.getElementById("root"));
