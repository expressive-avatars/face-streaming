var z=Object.defineProperty,$=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var v=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var E=(t,e,n)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,R=(t,e)=>{for(var n in e||(e={}))N.call(e,n)&&E(t,n,e[n]);if(v)for(var n of v(e))P.call(e,n)&&E(t,n,e[n]);return t},O=(t,e)=>$(t,Q(e));var L=(t,e)=>{var n={};for(var i in t)N.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(t!=null&&v)for(var i of v(t))e.indexOf(i)<0&&P.call(t,i)&&(n[i]=t[i]);return n};var f=(t,e,n)=>(E(t,typeof e!="symbol"?e+"":e,n),n);import{j as o,a as h,r as l,p as J,b as k,l as G,u as K,Q as I,C as Y,X as Z,c as A,d as F,V as U,e as ee,M as te,E as ne,f as re,g as se,B as oe,h as ie,F as C,i as ae,k as ce,R as le,m as ue}from"./vendor.51ca770e.js";const de=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}};de();function y(i){var r=i,{primary:t=!1,className:e}=r,n=L(r,["primary","className"]);return o("button",R({className:`${e} ${t?"border-0 text-white bg-hubs-blue hover:bh-hubs-lightblue":"border-2 border-hubs-blue text-hubs-blue hover:text-hubs-lightblue"} font-semibold px-5 py-2 rounded-lg flex items-center justify-center gap-2`},n))}function he(){return o("div",{className:"bg-white h-screen w-screen grid place-items-center gap-2",children:h("ul",{className:"w-72 list-decimal grid gap-2",children:[o("h1",{className:"font-bold mb-4 text-xl",children:"Almost there..."}),o("li",{children:"Swipe down on the status bar at the top of the screen"}),o("li",{children:"Tap the 3 dots in the URL bar"}),o("img",{src:"/breadcrumbs.jpg"}),o("li",{children:'Tap "Switch Camera"'}),o("img",{src:"/switch-camera.jpg",height:200})]})})}function M(){const[t]=l.exports.useState(()=>{try{const e=pe("credentials");return JSON.parse(e)}catch{return null}});return t}function pe(t){let e=t+"=",i=decodeURIComponent(document.cookie).split(";");for(let r=0;r<i.length;r++){let s=i[r];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(e)==0)return s.substring(e.length,s.length)}return""}class me{constructor(e,n={}){this.session=null,this.renderer=e,this.sessionInit=n,this._makeDefaultOverlay()}_makeDefaultOverlay(){if(this.sessionInit.domOverlay===void 0){const e=document.createElement("div");e.style.display="none",document.body.appendChild(e),this.sessionInit.optionalFeatures===void 0&&(this.sessionInit.optionalFeatures=[]),this.sessionInit.optionalFeatures.push("dom-overlay"),this.sessionInit.domOverlay={root:e}}}start(){navigator.xr.requestSession("immersive-ar",this.sessionInit).then(this.onSessionStarted.bind(this)).catch(e=>console.log("Failed to start AR session"))}end(){this.session.end()}get domOverlay(){return this.sessionInit.domOverlay}async onSessionStarted(e){this.session=e,e.addEventListener("end",this.onSessionEnded.bind(this)),this.renderer.xr.setReferenceSpaceType("local"),await this.renderer.xr.setSession(e),this.sessionInit.domOverlay.root.style.display=""}onSessionEnded(){this.session=null}}function fe(t){let e=t+"=",i=decodeURIComponent(document.cookie).split(";");for(let r=0;r<i.length;r++){let s=i[r];for(;s.charAt(0)==" ";)s=s.substring(1);if(s.indexOf(e)==0)return s.substring(e.length,s.length)}return""}function ge(){try{const t=fe("credentials");return JSON.parse(t)}catch{return null}}class be{constructor(){f(this,"trackingStarted",!1);f(this,"needsCalibration",!0);f(this,"paused",!1);f(this,"previewHidden",!1);f(this,"calibrationOrientation",k(new I));f(this,"subscribers",k(new Set));f(this,"credentials",k(ge()));f(this,"socket",k(G("https://expressive-avatars-server.herokuapp.com/provider",{query:{token:this.credentials.token}})))}register(e){return this.subscribers.add(e),()=>this.subscribers.delete(e)}calibrate(){this.needsCalibrate=!0}togglePause(){this.paused=!this.paused}}const c=J(new be),w=()=>K(c);function ye({hubName:t}){const e=()=>c.calibrate(),n=()=>{c.paused=!c.paused,c.socket.emit("state",{paused:c.paused})},i=w();return o("div",{className:"fixed bottom-0 flex justify-center w-full",children:h("div",{className:"bg-white rounded-t-lg shadow-lg w-[450px] mx-8 p-8 flex flex-col items-center gap-4",children:[h("div",{className:"flex flex-col items-center",children:[h("span",{className:"flex items-center gap-2",children:[o(we,{color:t?"green":"orange",size:10}),t?"Connected":"Waiting for connection..."]}),o("p",{className:"text-hubs-gray",children:t!=null?t:"Join a compatible room on Hubs desktop"})]}),h("span",{className:"flex gap-4",children:[h(y,{onClick:e,children:[o("span",{className:"bx bx-target-lock text-[20px]"})," Recenter"]}),o(y,{primary:i.paused,className:"w-[50px]",onClick:n,children:i.paused?o("span",{className:"bx bx-play scale-[2]"}):o("span",{className:"bx bx-pause scale-[2]"})}),o(y,{primary:i.previewHidden,className:"w-[50px]",onClick:()=>c.previewHidden=!c.previewHidden,children:i.previewHidden?o("span",{className:"bx bx-show scale-[2]"}):o("span",{className:"bx bx-hide scale-[2]"})})]})]})})}function we({color:t="green",size:e=10}){return o("div",{style:{display:"inline-block",width:e,height:e,backgroundColor:t,borderRadius:9999}})}function Se(r){var s=r,{onCreated:t,children:e,sessionInit:n}=s,i=L(s,["onCreated","children","sessionInit"]);return o(xe,O(R({onCreated:t},i),{children:e}))}function xe(i){var r=i,{foveation:t,children:e}=r,n=L(r,["foveation","children"]);return o(Y,O(R({vr:!0},n),{children:o(Z,{foveation:t,children:e})}))}function ve({children:t}){const{camera:e}=A();return F(t,e)}function T(t){l.exports.useEffect(()=>c.register(t),[t])}function Re({socket:t}){return T((e,n)=>{t.volatile.emit("face",{blendShapes:e,headOrientation:n.toArray()})}),null}const S=new U,D=new U;class Le{constructor(e){if(!e.isMesh)throw new Error("CPUMorpher requires a THREE.Mesh instance");if(this.mesh=e,!e.geometry.getAttribute("_position")){const n=e.geometry.getAttribute("position").clone();e.geometry.setAttribute("_position",n)}this.morphTargetInfluences=Array.from(e.morphTargetInfluences)}_applyMorphTargetInfluences(e){const n=this.mesh.geometry.getAttribute("position"),i=this.mesh.geometry.getAttribute("_position");for(let r=0;r<n.count;++r){S.fromBufferAttribute(i,r);for(let s=0;s<e.length;++s){const u=this.mesh.geometry.morphAttributes.position[s];D.fromBufferAttribute(u,r),S.addScaledVector(D,e[s])}n.setXYZ(r,S.x,S.y,S.z)}n.needsUpdate=!0}update(){this._applyMorphTargetInfluences(this.morphTargetInfluences)}}function ke({path:t}){const e=t!=null?t:"/faceless-avatar.glb",{scene:n,nodes:i}=ee(e);t||n.traverse(a=>{a.isMesh&&(a.material.metalness=1,a.material.roughness=.1,a.material.color.set("white"))});const{bones:r,meshes:s,morphers:u}=l.exports.useMemo(()=>{const a={head:i.Head,eyeL:i.LeftEye,eyeR:i.RightEye},m=[];n.traverse(d=>{var g;d.isMesh&&((g=d.morphTargetInfluences)==null?void 0:g.length)>0&&m.push(d)});const p=m.map(d=>new Le(d));return{bones:a,meshes:m,morphers:p}},[t]);return T((a,m)=>{r.head.setRotationFromQuaternion(m);for(let p of u){for(let d in a){const g=p.mesh.morphTargetDictionary[d];p.morphTargetInfluences[g]=a[d]}p.update()}try{r.eyeR.rotation.set(-Math.PI/2+a.eyeLookDownRight*.5-a.eyeLookUpRight*.5,0,Math.PI-a.eyeLookOutRight+a.eyeLookOutLeft),r.eyeL.rotation.copy(r.eyeR.rotation)}catch{}}),o("primitive",{object:n})}function _(t=()=>{}){const{gl:e}=A(),{xr:n}=e,[i,r]=l.exports.useState(()=>n.getSession());return l.exports.useEffect(()=>{const s=()=>{const u=n.getSession();t(u),r(u)};return n.addEventListener("sessionstart",s),n.addEventListener("sessionend",s),()=>{n.removeEventListener("sessionstart",s),n.removeEventListener("sessionend",s)}},[n]),i}function j(t){const e=_(),[n,i]=l.exports.useState();return l.exports.useEffect(()=>{e&&e.requestReferenceSpace(t).then(r=>i(r))},[e]),n}function Ce(t){return Object.fromEntries(Object.keys(B).map(e=>{var r,s;const n=B[e];let i=(r=t[n])!=null?r:0;return i*=(s=Ee[n])!=null?s:1,[e,i]}))}const Ee={mouthSmileLeft:.6,mouthSmileRight:.6},H=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"],Oe=t=>t.includes("Right")?t.replace("Right","Left"):t.replace("Left","Right"),B=Object.fromEntries(H.map(t=>[t,Oe(t)])),Ie=Object.fromEntries(H.map(t=>[t,0])),q=new te,W=new I,b=new ne;function Ae({socket:t}){const[e]=l.exports.useState(()=>new I);l.exports.useEffect(()=>{t.emit("provider_join");const a=p=>{switch(p){case"calibrate":c.calibrate();break}},m=p=>{for(let d in p)c[d]=p[d]};return t.on("action",a),t.on("state",m),()=>{t.removeListener("action",a),t.removeListener("state",m)}},[t]);const n=_(a=>{a&&a.updateWorldSensingState({meshDetectionState:{enabled:!0}})}),i=()=>{e.identity(),c.subscribers.forEach(a=>{a(Ie,e)})},r=w();l.exports.useEffect(()=>{n&&n.updateWorldSensingState({meshDetectionState:{enabled:!r.paused}}),r.paused&&i()},[r.paused]);const s=j("local"),u=j("viewer");return re((a,m)=>{const p=m.worldInformation;p.meshes&&s&&u&&p.meshes.forEach(d=>{if(d.changed&&d.blendShapes&&d.modelMatrix){const g=Ce(d.blendShapes);q.fromArray(d.modelMatrix),e.setFromRotationMatrix(q);const x=m.getPose(u,s).transform.orientation;W.set(x.x,x.y,x.z,x.w),e.premultiply(W),b.setFromQuaternion(e),b.y=-b.y,b.z=-b.z,e.setFromEuler(b),c.needsCalibrate&&(c.calibrationOrientation.copy(e).invert(),c.needsCalibrate=!1),e.premultiply(c.calibrationOrientation),c.subscribers.forEach(V=>{V(g,e)}),c.trackingStarted||(c.trackingStarted=!0)}})}),null}function Ne(){const[t,e]=l.exports.useState(window.innerWidth/window.innerHeight);return se(n=>{const i=window.innerWidth/window.innerHeight;i!==t&&e(i)}),t}function Pe({color:t="white"}){const{camera:e}=A();return F(o(oe,{children:o("meshBasicMaterial",{color:t,side:ie})}),e)}function Fe(){const[t]=l.exports.useState(()=>new me),e=s=>{t.renderer=s.gl,t.sessionInit.optionalFeatures=["worldSensing"],t.start()},n=w(),[i,r]=l.exports.useState();return l.exports.useEffect(()=>{const s=u=>r(u);return n.socket.on("hub_name",s),()=>n.socket.removeListener("hub_name",s)},[n.socket]),h(C,{children:[o(Se,{onCreated:e,children:o(Me,{socket:n.socket})}),ae.exports.createPortal(o(Ue,{hubName:i}),t.domOverlay.root)]})}function Ue({hubName:t}){const e=w();return h(C,{children:[e.previewHidden&&h("div",{className:"fixed w-screen h-screen grid text-center place-content-center gap-4",children:[o("p",{className:"text-hubs-gray",children:"(Preview hidden)"}),h("p",{className:"text-xl text-black",children:["Facetracking is ",o("b",{className:"text-black underline",children:e.paused?"PAUSED":"ACTIVE"})]})]}),e.trackingStarted?o(ye,{hubName:t}):o(he,{})]})}function Me({socket:t}){const[e,n]=l.exports.useState();l.exports.useEffect(()=>{const a=m=>n(m);return t.on("avatar_url",a),()=>t.removeListener("avatar_url",a)},[t]);const i=w(),s=Ne()>1,u=i.previewHidden||!i.trackingStarted;return h(C,{children:[u&&o(Pe,{color:"white"}),h(l.exports.Suspense,{fallback:null,children:[o(ce,{preset:"apartment",background:!0}),o(Ae,{socket:t}),o(Re,{socket:t}),o(ve,{children:o("group",{"position-z":s?-6:-5,scale:10,children:o("group",{position:[0,-.6,0],"scale-x":-1,children:o(ke,{path:e})})})})]})]})}function Te(){const[t,e]=l.exports.useState(!1);return t?o(Fe,{}):o(De,{onStartAR:()=>{console.log("starting XR session"),e(!0)}})}function De({onStartAR:t}){const e=M();return h("div",{className:"flex flex-col justify-center items-center w-full h-full",children:[o("img",{alt:"Augmented Environments Lab logo",src:"/ael-logo.jpg",width:200}),e?o(je,{onStartAR:t}):o(_e,{})]})}function _e(){const t=X();return o("a",{href:t,children:o(y,{children:"Sign In"})})}function je({onStartAR:t}){const{email:e}=M(),n=X();return h(C,{children:[h("div",{className:"mb-6 text-center",children:[h("p",{children:["Signed in as ",o("span",{className:"font-semibold",children:He(e)})]}),o("a",{className:"text-hubs-blue hover:text-hubs-lightblue",href:n,children:"Switch account"})]}),o(y,{primary:!0,onClick:t,children:"Start Tracking"})]})}function He(t){const[e,n]=t.split("@");return`${e.substring(0,3)}...@${n}`}function X(){const t=new URL("https://hubs.aelatgt.net/signin");return t.searchParams.set("sign_in_destination_url","https://ios.aelatgt.net"),t.toString()}le.render(o(ue.StrictMode,{children:o(Te,{})}),document.getElementById("root"));
